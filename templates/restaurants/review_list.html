{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}マイレビュー一覧 - NAGOYAMESHI{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- パンくずナビ -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'restaurants:index' %}">トップ</a></li>
            <li class="breadcrumb-item"><a href="{% url 'accounts:mypage' %}">マイページ</a></li>
            <li class="breadcrumb-item active" aria-current="page">マイレビュー一覧</li>
        </ol>
    </nav>

    <!-- ページヘッダー（統計付き） -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-comments text-primary"></i> マイレビュー一覧</h2>
        <div class="d-flex gap-2">
            <span class="badge bg-primary fs-6">{{ total_reviews }}件</span>
            {% if average_rating %}
            <span class="badge bg-success fs-6">平均 {{ average_rating|floatformat:1 }}★</span>
            {% endif %}
        </div>
    </div>

    <!-- 統計サマリー（Phase 5-3 追加） -->
    {% if total_reviews > 0 %}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white text-center">
                <div class="card-body py-3">
                    <h5 class="mb-1">{{ total_reviews }}</h5>
                    <small>総レビュー数</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white text-center">
                <div class="card-body py-3">
                    <h5 class="mb-1">{{ average_rating|floatformat:1 }}</h5>
                    <small>平均評価</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white text-center">
                <div class="card-body py-3">
                    <h5 class="mb-1">{{ reviewed_restaurants }}</h5>
                    <small>レビュー済み店舗</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark text-center">
                <div class="card-body py-3">
                    <h5 class="mb-1">{{ latest_review_date|date:"m/d" }}</h5>
                    <small>最新レビュー</small>
                </div>
            </div>
        </div>
    </div>

    <!-- フィルタリング（Phase 5-3 追加） -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-filter"></i> フィルター・検索</h6>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">評価</label>
                    <select name="rating" class="form-select">
                        <option value="">すべての評価</option>
                        <option value="5" {% if request.GET.rating == '5' %}selected{% endif %}>⭐⭐⭐⭐⭐ (5つ星)</option>
                        <option value="4" {% if request.GET.rating == '4' %}selected{% endif %}>⭐⭐⭐⭐ (4つ星)</option>
                        <option value="3" {% if request.GET.rating == '3' %}selected{% endif %}>⭐⭐⭐ (3つ星)</option>
                        <option value="2" {% if request.GET.rating == '2' %}selected{% endif %}>⭐⭐ (2つ星)</option>
                        <option value="1" {% if request.GET.rating == '1' %}selected{% endif %}>⭐ (1つ星)</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">並び順</label>
                    <select name="sort" class="form-select">
                        <option value="-created_at" {% if request.GET.sort == '-created_at' or not request.GET.sort %}selected{% endif %}>新しい順</option>
                        <option value="created_at" {% if request.GET.sort == 'created_at' %}selected{% endif %}>古い順</option>
                        <option value="-rating" {% if request.GET.sort == '-rating' %}selected{% endif %}>評価高い順</option>
                        <option value="rating" {% if request.GET.sort == 'rating' %}selected{% endif %}>評価低い順</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">レストラン名</label>
                    <input type="text" name="restaurant" class="form-control" placeholder="レストラン名で検索" value="{{ request.GET.restaurant }}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <div class="d-grid w-100">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> 検索
                        </button>
                    </div>
                </div>
            </form>
            {% if request.GET.rating or request.GET.sort != '-created_at' or request.GET.restaurant %}
            <div class="mt-2">
                <a href="{% url 'restaurants:review_list' %}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-undo"></i> フィルターをリセット
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if reviews %}
    <div class="row">
        {% for review in reviews %}
        <div class="col-lg-6 mb-4">
            <div class="card h-100 {% if not review.is_approved %}border-warning{% endif %}">
                <div class="card-body">
                    <!-- 店舗情報 -->
                    <div class="d-flex align-items-center mb-3">
                        {% if review.restaurant.image %}
                        <img src="{{ review.restaurant.image.url }}" class="rounded me-3" width="60" height="60" style="object-fit: cover;">
                        {% else %}
                        <div class="bg-light rounded me-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                            <i class="fas fa-utensils text-muted"></i>
                        </div>
                        {% endif %}
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                <a href="{% url 'restaurants:detail' review.restaurant.pk %}" class="text-decoration-none">
                                    {{ review.restaurant.name }}
                                </a>
                            </h6>
                            <span class="badge bg-primary">{{ review.restaurant.category.name }}</span>
                        </div>
                    </div>

                    <!-- レビュー内容 -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="text-warning">
                                {% for i in "12345" %}
                                    {% if review.rating >= i|add:0 %}
                                        <i class="fas fa-star"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                                <span class="ms-1 text-muted">{{ review.rating }}/5</span>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">{{ review.created_at|date:"Y年m月d日" }}</small>
                                {% if review.updated_at != review.created_at %}
                                <br><span class="badge bg-info">編集済み</span>
                                {% endif %}
                            </div>
                        </div>
                        <p class="mb-0 text-dark">{{ review.comment|truncatechars:120 }}</p>
                        {% if review.comment|length > 120 %}
                        <small class="text-muted">...続きを読むには詳細をご覧ください</small>
                        {% endif %}
                    </div>

                    <!-- 承認状態 -->
                    {% if not review.is_approved %}
                    <div class="mb-3">
                        <div class="alert alert-warning py-2 mb-0">
                            <i class="fas fa-clock"></i> 承認待ち - 管理者による承認をお待ちください
                        </div>
                    </div>
                    {% endif %}

                    <!-- アクション -->
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="{% url 'restaurants:detail' review.restaurant.pk %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye"></i> 店舗詳細
                        </a>
                        <div>
                            <a href="{% url 'restaurants:review_edit' review.pk %}" class="btn btn-outline-secondary btn-sm me-2" title="レビューを編集">
                                <i class="fas fa-edit"></i> 編集
                            </a>
                            <a href="{% url 'restaurants:review_delete' review.pk %}" class="btn btn-outline-danger btn-sm" title="レビューを削除" onclick="return confirm('本当にこのレビューを削除しますか？')">
                                <i class="fas fa-trash"></i> 削除
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- ページネーション（改良版） -->
    {% if is_paginated %}
    <nav aria-label="ページネーション" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if request.GET.rating %}&rating={{ request.GET.rating }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.restaurant %}&restaurant={{ request.GET.restaurant }}{% endif %}">
                    <i class="fas fa-angle-double-left"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.rating %}&rating={{ request.GET.rating }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.restaurant %}&restaurant={{ request.GET.restaurant }}{% endif %}">
                    <i class="fas fa-angle-left"></i>
                </a>
            </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if request.GET.rating %}&rating={{ request.GET.rating }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.restaurant %}&restaurant={{ request.GET.restaurant }}{% endif %}">{{ num }}</a>
                </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.rating %}&rating={{ request.GET.rating }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.restaurant %}&restaurant={{ request.GET.restaurant }}{% endif %}">
                    <i class="fas fa-angle-right"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.rating %}&rating={{ request.GET.rating }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.restaurant %}&restaurant={{ request.GET.restaurant }}{% endif %}">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <!-- レビューが空の場合（改良版） -->
    <div class="text-center py-5">
        <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
        <h4>{% if request.GET.rating or request.GET.restaurant %}該当するレビューが見つかりません{% else %}まだレビューがありません{% endif %}</h4>
        <p class="text-muted mb-4">
            {% if request.GET.rating or request.GET.restaurant %}
                条件を変更して再度検索してください
            {% else %}
                お気に入りの店舗にレビューを投稿してみましょう
            {% endif %}
        </p>
        <div>
            {% if request.GET.rating or request.GET.restaurant %}
                <a href="{% url 'restaurants:review_list' %}" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-undo"></i> フィルターをリセット
                </a>
            {% endif %}
            <a href="{% url 'restaurants:index' %}" class="btn btn-primary">
                <i class="fas fa-search"></i> お店を探す
            </a>
        </div>
    </div>
    {% endif %}
</div>

<script>
// 削除確認の強化
document.querySelectorAll('a[href*="delete"]').forEach(function(link) {
    link.addEventListener('click', function(e) {
        if (!confirm('本当にこのレビューを削除しますか？この操作は元に戻せません。')) {
            e.preventDefault();
        }
    });
});
</script>

{% endblock %}