{% extends 'layouts/base.html' %}

{% block title %}カード変更 - NAGOYAMESHI{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- パンくずナビ -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'restaurants:index' %}">トップ</a></li>
            <li class="breadcrumb-item"><a href="{% url 'accounts:mypage' %}">マイページ</a></li>
            <li class="breadcrumb-item"><a href="{% url 'accounts:card_manage' %}">カード管理</a></li>
            <li class="breadcrumb-item active">カード変更</li>
        </ol>
    </nav>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4>カード情報変更</h4>
                </div>
                <div class="card-body">
                    <!-- 現在のカード情報 -->
                    {% if current_payment_method %}
                    <div class="alert alert-info">
                        <h6>現在のカード</h6>
                        <p>{{ current_payment_method.card.brand|title }} ****{{ current_payment_method.card.last4 }}</p>
                        <p>有効期限: {{ current_payment_method.card.exp_month }}/{{ current_payment_method.card.exp_year }}</p>
                    </div>
                    {% endif %}

                    <!-- 注意事項 -->
                    <div class="alert alert-warning">
                        <strong>注意:</strong>
                        <ul class="mb-0">
                            <li>現在のカードは削除されます</li>
                            <li>新しいカードが即座に有効になります</li>
                        </ul>
                    </div>

                    <form id="card-change-form" method="post">
                        {% csrf_token %}
                        {% if current_payment_method %}
                        <input type="hidden" name="old_payment_method_id" value="{{ current_payment_method.id }}">
                        {% endif %}
                        
                        <div class="mb-3">
                            <label class="form-label">カード名義人</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="card-holder-name" 
                                   placeholder="YAMADA TARO"
                                   required>
                            <div class="form-text">
                                カードに書かれた名前をローマ字で入力してください
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">新しいカード番号</label>
                            <div id="card-number-element" class="form-control">
                                <!-- Stripe Elements -->
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">有効期限</label>
                                <div id="card-expiry-element" class="form-control">
                                    <!-- Stripe Elements -->
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">セキュリティコード</label>
                                <div id="card-cvc-element" class="form-control">
                                    <!-- Stripe Elements -->
                                </div>
                            </div>
                        </div>

                        <!-- エラー表示 -->
                        <div id="card-errors" class="alert alert-danger d-none"></div>

                        <!-- ボタン -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'accounts:card_manage' %}" class="btn btn-secondary">
                                戻る
                            </a>
                            <div>
                                <button type="button" class="btn btn-warning" onclick="confirmChange()">
                                    変更内容を確認
                                </button>
                                <button type="submit" id="submit-button" class="btn btn-primary" style="display: none;">
                                    カードを変更
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- セキュリティ情報 -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6>セキュリティについて</h6>
                        <ul class="small mb-0">
                            <li>全ての通信は暗号化されています</li>
                            <li>カード情報は安全に管理されます</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
// Stripe設定
const stripe = Stripe('{{ stripe_public_key }}');
const elements = stripe.elements();

// カード要素作成
const cardNumber = elements.create('cardNumber');
const cardExpiry = elements.create('cardExpiry');
const cardCvc = elements.create('cardCvc');

// 要素をマウント
cardNumber.mount('#card-number-element');
cardExpiry.mount('#card-expiry-element');
cardCvc.mount('#card-cvc-element');

// エラー表示
function showError(message) {
    const errorElement = document.getElementById('card-errors');
    errorElement.textContent = message;
    errorElement.classList.remove('d-none');
}

// 変更内容の確認
function confirmChange() {
    const holderName = document.getElementById('card-holder-name').value;
    
    if (!holderName) {
        alert('カード名義人を入力してください。');
        return;
    }
    
    if (confirm('カード情報を変更しますか？\n現在のカードは削除されます。')) {
        document.getElementById('submit-button').style.display = 'inline-block';
        document.querySelector('button[onclick="confirmChange()"]').style.display = 'none';
    }
}

// フォーム送信
document.getElementById('card-change-form').addEventListener('submit', async (event) => {
    event.preventDefault();
    
    const submitButton = document.getElementById('submit-button');
    submitButton.disabled = true;
    submitButton.textContent = '処理中...';
    
    try {
        // PaymentMethod作成
        const {paymentMethod, error} = await stripe.createPaymentMethod({
            type: 'card',
            card: cardNumber,
            billing_details: {
                name: document.getElementById('card-holder-name').value,
            },
        });

        if (error) {
            showError(error.message);
            submitButton.disabled = false;
            submitButton.textContent = 'カードを変更';
        } else {
            // サーバーに送信
            const formData = new FormData(document.getElementById('card-change-form'));
            formData.append('payment_method_id', paymentMethod.id);
            
            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData,
            });
            
            if (response.ok) {
                window.location.href = '{% url "accounts:card_manage" %}';
            } else {
                showError('カードの変更に失敗しました');
                submitButton.disabled = false;
                submitButton.textContent = 'カードを変更';
            }
        }
    } catch (err) {
        showError('エラーが発生しました');
        submitButton.disabled = false;
        submitButton.textContent = 'カードを変更';
    }
});
</script>
{% endblock %}