{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}ã‚«ãƒ¼ãƒ‰æƒ…å ±ç®¡ç† - NAGOYAMESHI{% endblock %}

{% block extra_css %}
<style>
    .card-brand-icon {
        width: 40px;
        height: 25px;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        display: inline-block;
    }
    
    .payment-method-card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .payment-method-card:hover {
        border-color: #007bff;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,123,255,0.3);
    }
    
    .payment-method-card.default {
        border-color: #28a745;
        background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
    }
    
    .default-badge {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .security-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
    }
    
    .btn-custom {
        border-radius: 10px;
        padding: 10px 20px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- ãƒ‘ãƒ³ããšãƒŠãƒ“ -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-light rounded px-3 py-2">
            <li class="breadcrumb-item"><a href="{% url 'restaurants:index' %}" class="text-decoration-none">ğŸ  ãƒˆãƒƒãƒ—</a></li>
            <li class="breadcrumb-item"><a href="{% url 'accounts:mypage' %}" class="text-decoration-none">ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</a></li>
            <li class="breadcrumb-item active" aria-current="page">ğŸ’³ ã‚«ãƒ¼ãƒ‰æƒ…å ±ç®¡ç†</li>
        </ol>
    </nav>

    <div class="row">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div class="col-lg-3 mb-4">
            <div class="card border-0 shadow-sm rounded-3">
                <div class="card-header bg-white border-0 pb-0">
                    <h5 class="card-title mb-0 text-center">
                        <i class="fas fa-user-circle fa-2x text-primary mb-2 d-block"></i>
                        ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†
                    </h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="{% url 'accounts:mypage' %}" class="list-group-item list-group-item-action border-0 py-3">
                        <i class="fas fa-home text-primary me-3"></i> ãƒã‚¤ãƒšãƒ¼ã‚¸
                    </a>
                    <a href="{% url 'accounts:profile_edit' %}" class="list-group-item list-group-item-action border-0 py-3">
                        <i class="fas fa-edit text-success me-3"></i> ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
                    </a>
                    <a href="{% url 'accounts:password_change' %}" class="list-group-item list-group-item-action border-0 py-3">
                        <i class="fas fa-key text-warning me-3"></i> ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
                    </a>
                    <a href="{% url 'accounts:subscription_manage' %}" class="list-group-item list-group-item-action border-0 py-3">
                        <i class="fas fa-crown text-warning me-3"></i> ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†
                    </a>
                    <a href="{% url 'accounts:card_manage' %}" class="list-group-item list-group-item-action active border-0 py-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <i class="fas fa-credit-card me-3"></i> ã‚«ãƒ¼ãƒ‰æƒ…å ±ç®¡ç†
                    </a>
                </div>
            </div>
            
            <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ± -->
            <div class="security-info mt-4">
                <div class="text-center">
                    <i class="fas fa-shield-alt fa-3x mb-3"></i>
                    <h6>å®‰å…¨ãªæ±ºæ¸ˆ</h6>
                    <p class="small mb-0">SSLæš—å·åŒ–ã§ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’å®‰å…¨ã«ä¿è­·ã—ã¦ã„ã¾ã™</p>
                </div>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="col-lg-9">
            <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-credit-card text-info me-3"></i>ã‚«ãƒ¼ãƒ‰æƒ…å ±ç®¡ç†</h2>
                    <p class="text-muted mb-0">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹æ”¯æ‰•ã„æ–¹æ³•ã‚’ç®¡ç†ã§ãã¾ã™</p>
                </div>
                <div>
                    <a href="{% url 'accounts:card_add' %}" class="btn btn-primary btn-custom">
                        <i class="fas fa-plus me-2"></i>æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
                    </a>
                </div>
            </div>

            <!-- ç™»éŒ²æ¸ˆã¿ã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
            {% if payment_methods %}
            <div class="row">
                {% for payment_method in payment_methods %}
                <div class="col-md-6 mb-4">
                    <div class="card payment-method-card h-100 {% if payment_method.id == default_payment_method %}default{% endif %}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="d-flex align-items-center">
                                    {% if payment_method.card.brand == 'visa' %}
                                        <i class="fab fa-cc-visa fa-2x text-primary me-3"></i>
                                    {% elif payment_method.card.brand == 'mastercard' %}
                                        <i class="fab fa-cc-mastercard fa-2x text-warning me-3"></i>
                                    {% elif payment_method.card.brand == 'amex' %}
                                        <i class="fab fa-cc-amex fa-2x text-success me-3"></i>
                                    {% elif payment_method.card.brand == 'jcb' %}
                                        <i class="fab fa-cc-jcb fa-2x text-info me-3"></i>
                                    {% else %}
                                        <i class="fas fa-credit-card fa-2x text-secondary me-3"></i>
                                    {% endif %}
                                    <div>
                                        <h6 class="mb-1">{{ payment_method.card.brand|title }}</h6>
                                        <p class="text-muted mb-0">****{{ payment_method.card.last4 }}</p>
                                    </div>
                                </div>
                                {% if payment_method.id == default_payment_method %}
                                <span class="default-badge">
                                    <i class="fas fa-star me-1"></i>ãƒ¡ã‚¤ãƒ³
                                </span>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>
                                    æœ‰åŠ¹æœŸé™: {{ payment_method.card.exp_month|stringformat:"02d" }}/{{ payment_method.card.exp_year }}
                                </small>
                            </div>
                            
                            <!-- ã‚«ãƒ¼ãƒ‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="btn-group" role="group">
                                    {% if payment_method.id != default_payment_method %}
                                    <button class="btn btn-outline-success btn-sm" onclick="setDefaultCard('{{ payment_method.id }}')">
                                        <i class="fas fa-star me-1"></i>ãƒ¡ã‚¤ãƒ³ã«è¨­å®š
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-outline-danger btn-sm" onclick="removeCard('{{ payment_method.id }}')">
                                        <i class="fas fa-trash me-1"></i>å‰Šé™¤
                                    </button>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-globe me-1"></i>{{ payment_method.card.country|upper }}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- ã‚«ãƒ¼ãƒ‰ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆ -->
            <div class="card border-0 shadow-sm rounded-3">
                <div class="card-body text-center py-5">
                    <i class="fas fa-credit-card fa-4x text-muted mb-4"></i>
                    <h4 class="text-muted mb-3">ã‚«ãƒ¼ãƒ‰ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</h4>
                    <p class="text-muted mb-4">ç¶™ç¶šçš„ãªã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨ã®ãŸã‚ã€æ”¯æ‰•ã„æ–¹æ³•ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
                    <a href="{% url 'accounts:card_add' %}" class="btn btn-primary btn-lg btn-custom">
                        <i class="fas fa-plus me-2"></i>æœ€åˆã®ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- è¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm rounded-3">
                        <div class="card-body text-center">
                            <i class="fas fa-exchange-alt fa-2x text-info mb-3"></i>
                            <h6>ã‚«ãƒ¼ãƒ‰ã‚’å¤‰æ›´</h6>
                            <p class="text-muted small mb-3">æ—¢å­˜ã®ã‚«ãƒ¼ãƒ‰ã‚’æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã«å¤‰æ›´ã—ã¾ã™</p>
                            <a href="{% url 'accounts:card_change' %}" class="btn btn-outline-info btn-custom">
                                <i class="fas fa-edit me-1"></i>ã‚«ãƒ¼ãƒ‰ã‚’å¤‰æ›´
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm rounded-3">
                        <div class="card-body text-center">
                            <i class="fas fa-file-invoice-dollar fa-2x text-warning mb-3"></i>
                            <h6>è«‹æ±‚æƒ…å ±ç®¡ç†</h6>
                            <p class="text-muted small mb-3">è©³ç´°ãªè«‹æ±‚å±¥æ­´ã¨è¨­å®šã‚’ç¢ºèªã—ã¾ã™</p>
                            <a href="{% url 'accounts:billing_portal' %}" class="btn btn-outline-warning btn-custom">
                                <i class="fas fa-external-link-alt me-1"></i>è«‹æ±‚ãƒãƒ¼ã‚¿ãƒ«
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ³¨æ„äº‹é … -->
            <div class="alert alert-info border-0 rounded-3 mt-4">
                <div class="d-flex align-items-start">
                    <i class="fas fa-info-circle fa-lg me-3 mt-1"></i>
                    <div>
                        <h6 class="alert-heading mb-2">ã”åˆ©ç”¨ã«ã¤ã„ã¦</h6>
                        <ul class="mb-0 small">
                            <li>ã‚«ãƒ¼ãƒ‰æƒ…å ±ã¯Stripeã«ã‚ˆã£ã¦å®‰å…¨ã«ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™</li>
                            <li>ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ã¯æ¬¡å›ã®è«‹æ±‚ã§ä½¿ç”¨ã•ã‚Œã¾ã™</li>
                            <li>ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹å‰ã«ã€åˆ¥ã®ã‚«ãƒ¼ãƒ‰ã‚’ãƒ¡ã‚¤ãƒ³ã«è¨­å®šã—ã¦ãã ã•ã„</li>
                            <li>æœ‰åŠ¹æœŸé™ãŒè¿‘ã¥ã„ãŸã‚«ãƒ¼ãƒ‰ã¯äº‹å‰ã«æ›´æ–°ã—ã¦ãã ã•ã„</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
function setDefaultCard(paymentMethodId) {
    if (confirm('ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’ãƒ¡ã‚¤ãƒ³ã®æ”¯æ‰•ã„æ–¹æ³•ã«è¨­å®šã—ã¾ã™ã‹ï¼Ÿ')) {
        fetch('{% url "accounts:set_default_card" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: 'payment_method_id=' + paymentMethodId
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
            }
        })
        .catch(error => {
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        });
    }
}

// ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤
function removeCard(paymentMethodId) {
    if (confirm('ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        fetch('{% url "accounts:remove_payment_method" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: 'payment_method_id=' + paymentMethodId
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
            }
        })
        .catch(error => {
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        });
    }
}
</script>
{% endblock %}